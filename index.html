<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flight Visualiser â€“ gayatro</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.88/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.88/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <style>
    #cesiumContainer {
      width: 100%;
      height: 100vh;
      margin: 0;
      padding: 0;
      display: none; /* Initially hidden */
    }
    #slider, #fileInput, #tokenInput, #initButton, #playPauseButton, #headingSlider {
      position: absolute;
      bottom: 20px;
    }
    #slider {
      left: 88.5%;
      bottom: 225px;
      transform: translateX(-50%);
      width: 300px;
      display: none; /* Initially hidden */
    }
    #headingSlider {
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      width: 300px;
      display: none; /* Initially hidden */
    }
    #headingLabel {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 40px;
      font-size: 14px;
      color: white;
      z-index: 1000;
      display: none; /* Initially hidden */
    }
    #pitchSlider {
      position: absolute;
      left: 20px; /* Position it towards the left of the screen */
      top: 72%; /* Adjust position */
      transform: translateY(-50%) rotate(-90deg); /* Rotate it to make it vertical */
      width: 300px;
      height: 20px; /* Adjust the height */
      transform-origin: left center; /* Set the rotation origin */
      writing-mode: bt-lr; /* Set writing mode to ensure the slider is vertical */
      display: none; /* Initially hidden */
      background: transparent; /* Ensure the background is transparent */
      z-index: 1000; /* Ensure it's above other elements */
    }
    #pitchLabel {
      position: absolute;
      color: #ffffff;
      left: 40px; /* Position it to the right of the slider */
      top: 55%; /* Align with the slider */
      transform: translateY(-50%) rotate(-90deg); /* Rotate the text to match the slider */
      transform-origin: left center;
      font-size: 13px;
      font-weight: bold;
      z-index: 1000;
      display: none; /* Initially hidden */
    }
    #fileInput {
      left: 20px;
      top: 20px;
      display: none; /* Initially hidden */
    }
    #tokenInput {
      left: 45%;
      bottom: 30px;
      transform: translateX(-50%);
      width: 300px;
      padding: 10px;
    }
    #initButton {
      left: 65%;
      bottom: 30px;
      transform: translateX(-50%);
    }
    #map {
      position: absolute;
      bottom: 20px;
      right: 9px;
      width: 300px;
      height: 200px;
      z-index: 1000;
      display: none; /* Initially hidden */
      border: 2px solid black;
    }
    #playPauseButton {
      right: 20px;
      bottom: 243px;
      display: none; /* Initially hidden */
    }
    #altitudeDisplay {
      position: absolute;
      top: 50px;
      right: 10px;
      color: white;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      z-index: 1000;
      display: none; /* Initially hidden */
    }
    /* Intro Text Styling */
    #introText {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9); /* Semi-transparent background */
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      max-width: 600px;
      text-align: left;
    }
    #introText h1 {
      margin-bottom: 20px;
      font-size: 28px;
      text-align: center;
    }
    #introText p {
      margin: 10px 0;
      font-size: 16px;
      line-height: 1.5;
    }
    #introText a {
      color: #007bff;
      text-decoration: none;
    }
    #introText a:hover {
      text-decoration: underline;
    }
    /* Styling for Terms of Service Link */
    #termsLink {
      font-size: 10px; /* Make the text smaller */
      display: block;
      text-align: right; /* Align to the right */
      margin-top: 10px; /* Add some space above */
    }
    #progressContainer {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      width: 300px;
      background-color: #f3f3f3;
      border-radius: 5px;
      display: none; /* Initially hidden */
    }

    #progressBar {
      width: 0%;
      height: 30px;
      background-color: #4caf50;
      border-radius: 5px;
      text-align: center;
      line-height: 30px;
      color: white;
    }
    #flightProgressLabel {
      position: absolute;
      right: 6%;
      bottom: 243px; 
      transform: translateX(-50%);
      font-size: 14px;
      color: white;
      z-index: 1000;
      display: none; /* Initially hidden */
    }
  </style>
</head>
<body>
  <div id="introText">
    <h1>Welcome to the Flight Visualiser</h1>
    <p>Please input your Cesium Access Token below and upload your CSV file on the next page to visualise the data in a 3D environment.</p>
    <p>If you do not have an access token, please create a free account and obtain one here: <a href="https://ion.cesium.com/signin/tokens?page=1" target="_blank">Cesium Ion</a>.</p>
    <p><strong>Important:</strong> The CSV file must contain the columns "Longitude", "Latitude", "Altitude", and "Bearing" (case sensitive).</p>
    <p>Before using this simulator, please visit this <a href="https://github.com/gayatro/fly-visual/tree/main" target="_blank">GitHub repository</a> and run the "data-processor" script to calculate the required parameters and format your data for this simulator. </p>
    <p>This repository also contains all instructions required to successfully run this simulator. </p>
    <p>Enjoy the simulation!</p>
    <a id="termsLink" href="https://cesium.com/legal/terms-of-service/" target="_blank">Cesium ion Terms of Service</a>
  </div>
  
  <div id="cesiumContainer"></div>
  <div id="map"></div>
  <input type="range" id="slider" min="0" max="100" value="0">
  <div id="pitchLabel">Pitch</div>
  <input type="range" id="pitchSlider" min="-90" max="90" value="-15">

  <!-- Viewing Direction Label and Slider -->
  <label id="headingLabel" for="headingSlider">Viewing Direction</label>
  <input type="range" id="headingSlider" min="-180" max="180" value="0">
  <!-- Flight Progress label -->
  <label id="flightProgressLabel" for="slider">Flight Progress</label>
  <input type="range" id="slider" min="0" max="100" value="0">

  <input type="file" id="fileInput" accept=".csv">
  <input type="text" id="tokenInput" placeholder="Enter Cesium Access Token">
  <button id="initButton">Initialise Map</button>
  <button id="playPauseButton">Play</button>
  
  <!-- Altitude Display -->
  <div id="altitudeDisplay">Altitude: 0 meters</div>

  <!-- Progress Bar Container -->
  <div id="progressContainer">
    <div id="progressBar">0%</div>
  </div>

  <script>
    let viewer;
    let coordinates = [];
    let currentIndex = 0;
    let isPlaying = false;
    let map, marker, polyline;

    // Function to initialize the Cesium viewer
    async function initializeCesium() {
      const accessToken = document.getElementById('tokenInput').value;

      if (accessToken) {
        Cesium.Ion.defaultAccessToken = accessToken;

        // Show the Cesium container and controls
        document.getElementById('cesiumContainer').style.display = 'block';
        document.getElementById('map').style.display = 'block';
        document.getElementById('slider').style.display = 'block';
        document.getElementById('fileInput').style.display = 'block';
        document.getElementById('playPauseButton').style.display = 'block';
        document.getElementById('headingSlider').style.display = 'block';
        document.getElementById('headingLabel').style.display = 'block';
        document.getElementById('tokenInput').style.display = 'none';
        document.getElementById('initButton').style.display = 'none';
        document.getElementById('pitchSlider').style.display = 'block';
        document.getElementById('pitchLabel').style.display = 'block';
        document.getElementById('altitudeDisplay').style.display = 'block';
        document.getElementById('flightProgressLabel').style.display = 'block'; // Show the Flight Progress label

        // Hide the intro text after initialization
        document.getElementById('introText').style.display = 'none';

        // Initialize the Cesium viewer with terrain
        viewer = new Cesium.Viewer('cesiumContainer', {
          terrainProvider: Cesium.createWorldTerrain()
        });

        // Add Cesium OSM Buildings
        const osmBuildings = viewer.scene.primitives.add(Cesium.createOsmBuildings());

        // Initialize Leaflet map
        map = L.map('map').setView([0, 0], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19
        }).addTo(map);

        polyline = L.polyline([], { color: 'red' }).addTo(map);
        marker = L.circleMarker([0, 0], {
            radius: 4, // Radius of the circle in pixels
            color: 'black', // Stroke color
            fillColor: 'pink', // Fill color
            fillOpacity: 0.5, // Fill opacity
        }).addTo(map).bringToFront();
      } else {
        alert('Please enter a valid Cesium access token.');
      }
    }

    function processFileInChunks(file) {
      const chunkSize = 1024 * 1024; // 1 MB chunks
      const totalChunks = Math.ceil(file.size / chunkSize);
      let currentChunk = 0;
      coordinates = [];

      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      progressContainer.style.display = 'block'; // Show progress bar

      const reader = new FileReader();
      reader.onload = function (e) {
        parseCSV(e.target.result); // Process each chunk
        currentChunk++;
        const progress = Math.floor((currentChunk / totalChunks) * 100);
        progressBar.style.width = progress + '%';
        progressBar.textContent = progress + '%';

        if (currentChunk < totalChunks) {
          readNextChunk();
        } else {
          progressContainer.style.display = 'none'; // Hide progress bar after completion
          if (coordinates.length > 0) {
            initializeMap(); // Initialize map after processing
          } else {
            alert('No valid coordinates found in the CSV file.');
          }
        }
      };

      function readNextChunk() {
        const start = currentChunk * chunkSize;
        const end = Math.min(start + chunkSize, file.size);
        const blob = file.slice(start, end);
        reader.readAsText(blob);
      }

      readNextChunk(); // Start reading the first chunk
    }

    // Parse the CSV file
    function parseCSV(csvText) {
      const rows = csvText.split('\n');
      const header = rows[0].split(',').map(column => column.trim().toLowerCase());

      const longitudeIndex = header.indexOf('longitude');
      const latitudeIndex = header.indexOf('latitude');
      const bearingIndex = header.indexOf('bearing');
      const altitudeIndex = header.indexOf('altitude');

      if (longitudeIndex === -1 || latitudeIndex === -1 || bearingIndex === -1 || altitudeIndex === -1) {
        alert('CSV file must contain "Longitude", "Latitude", "Bearing", and "Altitude" columns.');
        return;
      }

      rows.slice(1).forEach(row => {
        const columns = row.split(',');
        const longitude = parseFloat(columns[longitudeIndex]);
        const latitude = parseFloat(columns[latitudeIndex]);
        const bearing = parseFloat(columns[bearingIndex]);
        const altitude = parseFloat(columns[altitudeIndex]);

        if (!isNaN(longitude) && !isNaN(latitude) && !isNaN(bearing) && !isNaN(altitude)) {
          coordinates.push({ longitude, latitude, bearing, altitude });
          polyline.addLatLng([latitude, longitude]); // Add point to the polyline
        }
      });

      if (coordinates.length > 0) {
        document.getElementById('slider').max = coordinates.length - 1;
        const { latitude, longitude } = coordinates[0];
        map.setView([latitude, longitude], 12); // Center the map on the first point
        marker.setLatLng([latitude, longitude]); // Place the marker at the first point
      } else {
        alert('No valid coordinates found in the CSV file.');
      }
    }

    // Function to move the camera continuously between points
    function playFlythrough() {
      if (!isPlaying || currentIndex >= coordinates.length) return;

      const { longitude, latitude, bearing, altitude } = coordinates[currentIndex];
      const destination = Cesium.Cartesian3.fromDegrees(longitude, latitude, altitude);

      const baseHeading = Cesium.Math.toRadians(bearing);
      const headingOffset = Cesium.Math.toRadians(parseFloat(document.getElementById('headingSlider').value));
      const heading = baseHeading + headingOffset;

      const pitch = Cesium.Math.toRadians(parseFloat(document.getElementById('pitchSlider').value));

      viewer.camera.flyTo({
        destination: destination,
        orientation: {
          heading: heading,
          pitch: pitch,
          roll: 0
        },
        duration: 0.1, // Shorter duration for faster transitions
        complete: () => {
          marker.setLatLng([latitude, longitude]); // Move the marker to the current point
          document.getElementById('altitudeDisplay').textContent = `Altitude: ${altitude} meters`; // Update altitude display
          
          // Ensure altitude is a valid number and format it to 3 decimal places
          const altitudeText = !isNaN(altitude) ? altitude.toFixed(3) : 'N/A';
          document.getElementById('altitudeDisplay').textContent = `Altitude: ${altitudeText} meters`; // Update altitude display
          currentIndex += 2; // Increase step size to speed up flythrough (can adjust as needed)
          if (currentIndex >= coordinates.length) {
            currentIndex = 0; // Loop back to the start
          }
          playFlythrough(); // Continue the flythrough
        }
      });

      document.getElementById('slider').value = currentIndex;
    }

    // Event listener for the slider
    document.getElementById('slider').addEventListener('input', function (event) {
      currentIndex = parseInt(event.target.value, 10);
      isPlaying = false; // Stop the auto-play if the slider is used
      document.getElementById('playPauseButton').textContent = 'Play';
      moveToCoordinate(currentIndex, 0.1); // Instant move for slider interaction
    });

    // Function to move the camera to a specific point with bearing and elevation
    function moveToCoordinate(index, duration = 0.1) {
      if (index < 0 || index >= coordinates.length) return;

      const { longitude, latitude, bearing, altitude } = coordinates[index];
      const destination = Cesium.Cartesian3.fromDegrees(longitude, latitude, altitude);

      const baseHeading = Cesium.Math.toRadians(bearing);
      const headingOffset = Cesium.Math.toRadians(parseFloat(document.getElementById('headingSlider').value));
      const heading = baseHeading + headingOffset;

      const pitch = Cesium.Math.toRadians(parseFloat(document.getElementById('pitchSlider').value));

      viewer.camera.flyTo({
        destination: destination,
        orientation: {
          heading: heading,
          pitch: pitch,
          roll: 0
        },
        duration: duration
      });

      document.getElementById('slider').value = index;
      const altitudeText = !isNaN(altitude) ? altitude.toFixed(3) : 'N/A';
      document.getElementById('altitudeDisplay').textContent = `Altitude: ${altitudeText} meters`; // Update altitude display

      marker.setLatLng([latitude, longitude]); // Move the marker to the current point
    }

    // Event listener for play/pause button
    document.getElementById('playPauseButton').addEventListener('click', function () {
      if (isPlaying) {
        isPlaying = false;
        this.textContent = 'Play';
      } else {
        isPlaying = true;
        this.textContent = 'Pause';
        playFlythrough(); // Start the flythrough
      }
    });

    // Event listener for file input
    document.getElementById('fileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (file) {
        processFileInChunks(file); // Use chunked processing for the file
      }
    });

    // Initialize Cesium on button click
    document.getElementById('initButton').addEventListener('click', initializeCesium);
  </script>
</body>
</html>
